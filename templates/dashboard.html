<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Completo de Cubos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#111827; color:#fff; margin:0; padding:20px; }
h1 { text-align:center; }
.grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
    gap:20px;
}
.card {
    background:#1f2937;
    padding:15px;
    border-radius:12px;
    box-shadow:0 8px 20px rgba(0,0,0,0.4);
}
</style>
</head>

<body>

<h1>Dashboard Completo de Cubos</h1>

<div class="grid">

    <div class="card">
        <h3>Aceptados vs Rechazados</h3>
        <canvas id="chartResumen"></canvas>
        <p id="textoResumen"></p>
    </div>

    <div class="card">
        <h3>Promedio de Confianza por Color</h3>
        <canvas id="chartConfianza"></canvas>
    </div>

    <div class="card">
        <h3>Tiempo Promedio por Cantidad</h3>
        <canvas id="chartTiempo"></canvas>
    </div>

    <div class="card">
        <h3>Pedidos m√°s Populares (Pastel)</h3>
        <canvas id="chartPopulares"></canvas>
    </div>

</div>

<script>
let chartResumen, chartConfianza, chartTiempo, chartPopulares;

/* 
    ACEPTADOS VS RECHAZADOS */
function actualizarResumen() {
    fetch("/api/resumen")
        .then(r=>r.json())
        .then(d=>{
            const ctx = document.getElementById("chartResumen").getContext("2d");
            const data = [d.aceptado, d.rechazado];

            if (!chartResumen) {
                chartResumen = new Chart(ctx, {
                    type:"bar",
                    data:{
                        labels:["Aceptados","Rechazados"],
                        datasets:[{ data:data, backgroundColor:["#10b981","#ef4444"] }]
                    }
                });
            } else {
                chartResumen.data.datasets[0].data = data;
                chartResumen.update();
            }

            document.getElementById("textoResumen").textContent =
                `Aceptados: ${d.aceptado}  |  Rechazados: ${d.rechazado}`;
        });
}

/* 
     PROMEDIO CONFIANZA */
function actualizarConfianza() {
    fetch("/api/confianza")
        .then(r=>r.json())
        .then(d=>{
            const ctx = document.getElementById("chartConfianza").getContext("2d");

            const labels = Object.keys(d);
            const valores = Object.values(d);

            if (!chartConfianza) {
                chartConfianza = new Chart(ctx,{
                    type:"bar",
                    data:{
                        labels:labels,
                        datasets:[{ 
                            data:valores,
                            backgroundColor:["#ef4444","#10b981","#3b82f6","#8b5cf6"]
                        }]
                    }
                });
            } else {
                chartConfianza.data.labels = labels;
                chartConfianza.data.datasets[0].data = valores;
                chartConfianza.update();
            }
        });
}

/*
    TIEMPOS PROMEDIO */
function actualizarTiempo() {
    fetch("/api/tiempos")
        .then(r=>r.json())
        .then(d=>{
            const ctx = document.getElementById("chartTiempo").getContext("2d");

            const labels = Object.keys(d).map(x=>x+" cubos");
            const valores = Object.values(d);

            if (!chartTiempo) {
                chartTiempo = new Chart(ctx,{
                    type:"line",
                    data:{
                        labels:labels,
                        datasets:[{
                            label:"Minutos promedio",
                            data:valores,
                            borderColor:"#fbbf24",
                            tension:0.3
                        }]
                    }
                });
            } else {
                chartTiempo.data.labels = labels;
                chartTiempo.data.datasets[0].data = valores;
                chartTiempo.update();
            }
        });
}

/* 
     PEDIDOS POPULARES
 */
function actualizarPopulares() {
    fetch("/api/populares")
        .then(r=>r.json())
        .then(d=>{
            const ctx = document.getElementById("chartPopulares").getContext("2d");

            const labels = Object.keys(d).map(x=>x+" cubos");
            const valores = Object.values(d);

            if (!chartPopulares) {
                chartPopulares = new Chart(ctx,{
                    type:"pie",
                    data:{
                        labels:labels,
                        datasets:[{
                            data:valores,
                            backgroundColor:["#3b82f6","#10b981","#ef4444","#f97316","#8b5cf6"]
                        }]
                    }
                });
            } else {
                chartPopulares.data.labels = labels;
                chartPopulares.data.datasets[0].data = valores;
                chartPopulares.update();
            }
        });
}

/* 
    AUTO CARGA AL ENTRAR */
function cargarTodo() {
    actualizarResumen();
    actualizarConfianza();
    actualizarTiempo();
    actualizarPopulares();
}

cargarTodo();
// Recargar cada 10 segundos
setInterval(cargarTodo, 10000);
</script>

</body>
</html>
